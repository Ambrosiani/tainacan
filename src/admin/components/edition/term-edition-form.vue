<template>
    <form
            id="termEditForm"
            class="tainacan-form"
            @submit.prevent="saveEdition(editForm)">
        <div class="tainacan-page-title">
            <h2>{{ $i18n.get("title_term_edition") }}</h2>
            <hr>
        </div>

        <!-- Header Image -------------------------------- -->
        <b-field
                :addons="false"
                :label="$i18n.get('label_header_image')">
            <div class="thumbnail-field">
                <figure class="image">
                    <span
                            v-if="editForm.header_image === undefined || editForm.header_image === false"
                            class="image-placeholder">{{ $i18n.get('label_empty_header_image') }}</span>
                    <img
                            :alt="$i18n.get('label_header_image')"
                            :src="(editForm.header_image === undefined || editForm.header_image === false) ? headerPlaceholderPath : editForm.header_image">
                </figure>
                <div class="thumbnail-buttons-row">
                    <a
                            class="button is-rounded is-secondary"
                            id="button-edit-header"
                            :aria-label="$i18n.get('label_button_edit_header_image')"
                            @click="headerImageMediaFrame.openFrame($event)">
                        <b-icon 
                            size="is-small"
                            icon="pencil"/>
                    </a>
                    <a
                            class="button is-rounded is-secondary"
                            id="button-delete-header"
                            :aria-label="$i18n.get('label_button_delete_thumb')"
                            @click="deleteHeaderImage()">
                        <b-icon 
                            size="is-small"
                            icon="delete" />
                    </a>
                </div>
                <br>
            </div>
        </b-field>
    
        <!-- Name -------------- -->
        <b-field
                :addons="false"
                :type="((formErrors.name !== '' || formErrors.repeated !== '') && (formErrors.name !== undefined || formErrors.repeated !== undefined )) ? 'is-danger' : ''"
                :message="formErrors.name ? formErrors : formErrors.repeated">
            <label class="label is-inline">
                {{ $i18n.get('label_name') }}
                <span class="required-term-asterisk">*</span>
                <help-button
                        :title="$i18n.get('label_name')"
                        :message="$i18n.get('info_help_term_name')"/>
            </label>
            <b-input
                    v-model="editForm.name"
                    name="name"
                    @focus="clearErrors({ name: 'name', repeated: 'repeated' })"/>
        </b-field>

        <!-- Description -------------- -->
        <b-field
                :addons="false"
                :type="formErrors['description'] !== '' && formErrors['description'] !== undefined ? 'is-danger' : ''"
                :message="formErrors['description']">
            <label class="label">
                {{ $i18n.get('label_description') }}
                <help-button
                        :title="$i18n.get('label_description')"
                        :message="$i18n.get('info_help_term_description')"/>
            </label>
            <b-input
                    type="textarea"
                    name="description"
                    v-model="editForm.description"
                    @focus="clearErrors('description')"/>
        </b-field>

        <!-- Parent -------------- -->
        <b-field
                :addons="false"
                :type="((formErrors.parent !== '' || formErrors.repeated !== '') && (formErrors.parent !== undefined || formErrors.repeated !== undefined )) ? 'is-danger' : ''"
                :message="formErrors.parent ? formErrors : formErrors.repeated">
            <label class="label is-inline">
                {{ $i18n.get('label_parent_term') }}
                <span class="required-term-asterisk">*</span>
                <help-button
                        :title="$i18n.get('label_parent_term')"
                        :message="$i18n.get('info_help_term_parent')"/>
            </label>
            <b-input
                    v-model="editForm.parent"
                    name="parent"
                    @focus="clearErrors({ name: 'parent', repeated: 'repeated' })"/>
        </b-field>
        <b-field
                :addons="false"
                :type="((formErrors.parent !== '' || formErrors.repeated !== '') && (formErrors.parent !== undefined || formErrors.repeated !== undefined )) ? 'is-danger' : ''"
                :message="formErrors.parent ? formErrors : formErrors.repeated">
           <label class="label is-inline">
                {{ $i18n.get('label_parent_term') }}
                <span class="required-term-asterisk">*</span>
                <help-button
                        :title="$i18n.get('label_parent_term')"
                        :message="$i18n.get('info_help_term_parent')"/>
            </label>
            <b-autocomplete
                    id="tainacan-text-cover-page"
                    :placeholder="$i18n.get('instruction_parent_term')"
                    :data="parentTerms"
                    v-model="parentTermName"
                    @select="onSelectParentTerm($event)"
                    :loading="isFetchingParentTerms"
                    @input="fecthParentTerms($event)"
                    @focus="clearErrors('parent')">
                <template slot-scope="props">
                    {{ props.option.name }}
                </template>
                <template slot="empty">{{ $i18n.get('info_no_parent_term_found') }}</template>
            </b-autocomplete>
        </b-field>

        <!-- Submit buttons -------------- -->
        <div class="field is-grouped form-submit">
            <div class="control">
                <button
                        type="button"
                        class="button is-outlined"
                        @click.prevent="cancelEdition()"
                        slot="trigger">
                    {{ $i18n.get('cancel') }}
                </button>
            </div>
            <div class="control">
                <a
                        type="button"
                        v-if="editForm.url != undefined && editForm.url!= ''"
                        class="button is-secondary"
                        :href="editForm.url">
                    {{ $i18n.get('see') + ' ' + $i18n.get('term') }}
                </a>
            </div>
            <div class="control">
                <button
                        class="button is-success"
                        type="submit">
                    {{ $i18n.get('save') }}
                </button>
            </div>
        </div>
    </form>
</template>

<script>
    import {mapActions, mapGetters} from 'vuex';
    import wpMediaFrames from '../../js/wp-media-frames';

    export default {
        name: 'TermEditionForm',
        data() {
            return {
                formErrors: {},
                headerPlaceholderPath: tainacan_plugin.base_url + '/admin/images/placeholder_rectangle.png',
                headerImageMediaFrame: undefined,
                isFetchingParentTerms: false,
                parentTerms: [],
                parentTermName: ''
            }
        },
        props: {
            editForm: Object,
            taxonomyId: ''
        },
        methods: {
            ...mapActions('taxonomy', [
                'sendChildTerm',
                'updateChildTerm',
                'fetchParentName',
                'fetchPossibleParentTerms'
            ]),
            ...mapGetters('taxonomy', [
                'getTerms'
            ]),
            saveEdition(term) {

                if (term.id === 'new') {
                    this.sendChildTerm({
                        taxonomyId: this.taxonomyId,
                        name: this.editForm.name,
                        description: this.editForm.description,
                        parent: this.editForm.parent,
                        headerImageId: this.editForm.header_image_id,
                    })
                        .then((term) => {
                            this.$emit('onEditionFinished', term);
                            this.editForm = {};
                            this.formErrors = {};
                        })
                        .catch((errors) => {
                            for (let error of errors.errors) {
                                for (let metadatum of Object.keys(error)) {
                                    this.$set(this.formErrors, metadatum, (this.formErrors[metadatum] !== undefined ? this.formErrors[metadatum] : '') + error[metadatum] + '\n');
                                }
                            }
                            this.$emit('onErrorFound');
                        });

                } else {
                    this.updateChildTerm({
                        taxonomyId: this.taxonomyId,
                        termId: this.editForm.id,
                        name: this.editForm.name,
                        description: this.editForm.description,
                        parent: this.editForm.parent,
                        headerImageId: this.editForm.header_image_id,
                    })
                        .then(() => {
                            this.formErrors = {};
                            this.$emit('onEditionFinished', this.editForm);
                        })
                        .catch((errors) => {
                            for (let error of errors.errors) {
                                for (let metadatum of Object.keys(error)) {
                                    this.$set(this.formErrors, metadatum, (this.formErrors[metadatum] !== undefined ? this.formErrors[metadatum] : '') + error[metadatum] + '\n');
                                }
                            }
                            this.$emit('onErrorFound');
                        });
                }
            },
            cancelEdition() {
                this.$emit('onEditionCanceled', this.editForm);
            },
            deleteHeaderImage() {
                this.editForm = Object.assign({},
                    this.editForm,
                    {
                        header_image_id: "0",
                        header_image: false
                    }
                );
            },
            initializeMediaFrames() {
                this.headerImageMediaFrame = new wpMediaFrames.headerImageControl(
                    'my-header-image-media-frame', {
                        button_labels: {
                            frame_title: this.$i18n.get('instruction_select_term_header_image'),
                        },
                        relatedPostId: this.editForm.id,
                        onSave: (croppedImage) => {
                           this.editForm = Object.assign({},
                                this.editForm,
                                {
                                    header_image_id: croppedImage.id.toString(),
                                    header_image: croppedImage.url
                                }
                            );
                        }
                    }
                );
            },
            clearErrors(attributes) {
                if(attributes instanceof Object){
                    for(let attribute in attributes){
                        this.formErrors[attribute] = undefined;
                    }
                } else {
                    this.formErrors[attributes] = undefined;
                }
            },
            fecthParentTerms(search) {
                this.isFetchingParentTerms = true;
                
                this.fetchPossibleParentTerms({
                        taxonomyId: this.taxonomyId, 
                        termId: this.editForm.id, 
                        search: search })
                    .then((parentTerms) => {
                        this.parentTerms = parentTerms;
                        this.isFetchingParentTerms = false;
                    })
                    .catch((error) => {
                        this.$console.error(error);
                        this.isFetchingParentTerms = false;
                    });
            },
            onSelectParentTerm(selectedParentTerm) {
                this.editForm.parent = selectedParentTerm.id;
                this.selectedParentTerm = selectedParentTerm;
                this.parentTermName = selectedParentTerm.name;

                    console.log(this.parentTermName);
            }
        },
        mounted() {
            this.initializeMediaFrames();
            this.isFetchingParentTerms = true;
            this.fetchParentName({ taxonomyId: this.taxonomyId, parentId: this.editForm.parent })
                .then((parentName) => {
                    this.parentTermName = parentName;
                    this.isFetchingParentTerms = false;
                })
                .catch((error) => {
                    this.$console.error(error);
                    this.isFetchingParentTerms = false;
                });
        }
    }
</script>

<style lang="scss" scoped>

    @import "../../scss/_variables.scss";

    .column {
        padding: 0;
        &.is-narrow {
            padding-right: 42px;
        }
    }    

    @keyframes enter {
        from {
            opacity: 0;
            transform: translate(-40px,0);
        }
        to {
            opacity: 1;
            transform: translate(0px,0);
        }
    }

    form {
        padding: 1.7rem 0 1.5rem 1.5rem;
        border-left: 1px solid $gray2;
        margin-left: 0.75rem;
        position: relative;
        animation-name: enter;
        animation-duration: 0.5s;

        .tainacan-page-title {
            margin-bottom: 40px;

            h2 {
                font-size: 20px;
                font-weight: 500;
                color: $blue5;
                display: inline-block;
            }
            hr{
                margin: 3px 0px 4px 0px; 
                height: 1px;
                background-color: $secondary;
            }
        }

        .thumbnail-field {

            .content {
                padding: 10px;
                font-size: 0.8em;
            }
            img {
                position: relative;
            }
            .image-placeholder {
                position: absolute;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
                top: 35%;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 99;
                text-align: center;
                color: $gray4;
            }
            #button-delete-header,
            #button-edit-header {

                border-radius: 100px !important;
                height: 30px !important;
                width: 30px !important;
                z-index: 99;
                margin-left: 10px !important;
                
                .icon {
                    display: inherit;
                    padding: 0;
                    margin: 0;
                    margin-top: 1px;
                    font-size: 18px;
                }
            }
                
            .thumbnail-buttons-row {
                text-align: right;
                top: -15px;
                position: relative;
            }
        }
    }

</style>


